<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracking Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #controls { padding:10px; background:#f9f9f9; display:flex; gap:5px; flex-wrap:wrap; }
    #controls input { flex:1; padding:8px; font-size:16px; }
    #controls button { padding:8px 12px; font-size:16px; }
    #map { height: calc(100% - 60px); width: 100%; }
  </style>
</head>
<body>
  <div id="controls">
    <input id="room" placeholder="Enter Room ID"/>
    <input id="deviceName" placeholder="Your Name"/>
    <button onclick="joinRoom()">Join</button>
    <button onclick="toggleRoute()">Chỉ đường</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCn1K76GDbRiXN6_n3yNBgzvb6taUXGOVM",
      authDomain: "tracking-bb8db.firebaseapp.com",
      databaseURL: "https://tracking-bb8db-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tracking-bb8db",
      storageBucket: "tracking-bb8db.firebasestorage.app",
      messagingSenderId: "376993985667",
      appId: "1:376993985667:web:bb7dfb60f76c9ba5f8d7b6",
      measurementId: "G-DLP0C73TCP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let map = L.map('map').setView([16.0471, 108.2068], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(map);

    const myIcon = L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png", iconSize: [32,32] });
    const otherIcon = L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/149/149059.png", iconSize: [32,32] });

    let myId = "device-" + Math.random().toString(36).substr(2,9);
    let myName = "";
    let roomId = null;
    let markers = {};
    let routeControl = null;
    let routeVisible = false;
    let latestData = {};

    function joinRoom() {
      roomId = document.getElementById('room').value;
      myName = document.getElementById('deviceName').value || "Unknown";
      if (!roomId) return alert("Enter a room ID");

      const myRef = ref(db, 'rooms/' + roomId + '/' + myId);

      // Xóa node khi disconnect
      onDisconnect(myRef).remove();

      // Cập nhật vị trí liên tục
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          set(myRef, { lat, lon, name: myName, lastActive: Date.now() });
        });
      } else {
        alert("Geolocation not supported");
      }

      // Nghe dữ liệu phòng
      onValue(ref(db, 'rooms/' + roomId), snapshot => {
        const data = snapshot.val();
        if (!data) return;
        latestData = data;

        const now = Date.now();

        // Xóa marker không còn / quá hạn
        for (let id in markers) {
          if (!data[id] || (now - (data[id].lastActive || 0) > 30000)) {
            map.removeLayer(markers[id]);
            delete markers[id];
          }
        }

        // Cập nhật / thêm marker
        for (let deviceId in data) {
          const { lat, lon, name, lastActive } = data[deviceId];
          if (!lat || !lon) continue;
          if (now - lastActive > 30000) continue; // quá hạn 30s

          const label = deviceId === myId ? `You (${name})` : `Friend (${name})`;

          if (markers[deviceId]) {
            markers[deviceId].setLatLng([lat, lon]).bindPopup(label);
          } else {
            markers[deviceId] = L.marker([lat, lon], { icon: deviceId === myId ? myIcon : otherIcon })
              .addTo(map)
              .bindPopup(label);
          }
        }

        if (routeVisible) toggleRoute();
      });
    }

    function toggleRoute() {
      if (routeControl) {
        map.removeControl(routeControl);
        routeControl = null;
        routeVisible = false;
      } else {
        if (!roomId) return alert("Join a room first");

        const friends = Object.keys(latestData).filter(id => id !== myId);
        if (friends.length === 0) return alert("No friend found");

        const me = latestData[myId];
        const friend = latestData[friends[0]];
        if (!me || !friend) return;

        routeControl = L.Routing.control({
          waypoints: [
            L.latLng(me.lat, me.lon),
            L.latLng(friend.lat, friend.lon)
          ],
          routeWhileDragging: true,
          show: false,
          addWaypoints: false,
          createMarker: () => null,
          router: L.Routing.osrmv1({ serviceUrl: "https://router.project-osrm.org/route/v1" })
        }).addTo(map);

        routeVisible = true;
      }
    }

    window.joinRoom = joinRoom;
    window.toggleRoute = toggleRoute;
  </script>
</body>
</html>

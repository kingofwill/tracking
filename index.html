<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tracking App VN Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
#map { width:100%; height:100%; }
#controls {
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  background:white; padding:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.3);
  z-index:9999; text-align:center;
}
input, button {
  margin:4px; padding:10px; font-size:16px; border-radius:6px; border:1px solid #ccc;
}
button { cursor:pointer; }
#cancelBtn { background-color:#e74c3c; color:white; font-weight:bold; }
#cancelBtn:hover { background-color:#c0392b; }
</style>
</head>
<body>

<div id="controls">
  <input type="text" id="roomId" placeholder="Room ID">
  <input type="text" id="deviceId" placeholder="Device ID">
  <input type="text" id="deviceName" placeholder="Tên thiết bị">
  <button onclick="join()">Join</button>
  <br>
  <button id="cancelBtn" onclick="cancelRoute()">Hủy chỉ đường</button>
</div>

<div id="map"></div>

<!-- Leaflet + Firebase -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCn1K76GDbRiXN6_n3yNBgzvb6taUXGOVM",
  authDomain: "tracking-bb8db.firebaseapp.com",
  databaseURL: "https://tracking-bb8db-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tracking-bb8db",
  storageBucket: "tracking-bb8db.appspot.com",
  messagingSenderId: "376993985667",
  appId: "1:376993985667:web:bb7dfb60f76c9ba5f8d7b6",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Map VN OSM
const map = L.map('map').setView([16.0471,108.2068],6);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Biến
let roomId, myId, myName;
let myMarker;
let markers = {};
let routeLine;

// Join room + cập nhật vị trí
function join() {
  roomId = document.getElementById('roomId').value.trim();
  myId = document.getElementById('deviceId').value.trim();
  myName = document.getElementById('deviceName').value.trim();
  if(!roomId||!myId||!myName){ alert("Nhập đầy đủ thông tin!"); return; }

  const ref = db.ref('rooms/'+roomId+'/'+myId);

  if(navigator.geolocation){
    navigator.geolocation.watchPosition(pos=>{
      const lat = pos.coords.latitude, lng=pos.coords.longitude;
      ref.set({name:myName,lat,lng,timestamp:Date.now()});

      if(!myMarker){
        myMarker = L.marker([lat,lng],{title:"Tôi", icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',iconSize:[32,32]})})
                    .addTo(map).bindPopup("Tôi").openPopup();
      }else{
        myMarker.setLatLng([lat,lng]);
      }
      map.setView([lat,lng]);
    }, err=>{console.error(err);},{enableHighAccuracy:true});
  }

  // Lắng nghe tất cả device trong room
  db.ref('rooms/'+roomId).on('value',snap=>{
    const devices = snap.val()||{};
    updateMarkers(devices);
  });

  // Xóa khi thoát
  window.addEventListener('beforeunload',()=>{ ref.remove(); });
}

// Cập nhật marker
function updateMarkers(devices){
  // Xóa marker cũ
  for(const id in markers){
    map.removeLayer(markers[id]);
  }
  markers = {};

  for(const id in devices){
    const {name,lat,lng}=devices[id];
    if(!lat||!lng) continue;
    if(id===myId) continue;

    const m = L.marker([lat,lng],{title:name})
                .addTo(map)
                .bindPopup(name);

    // Bấm vào marker để chỉ đường
    m.on('click',()=>{ showRouteToMarker(m); });
    markers[id] = m;
  }
}

// Vẽ tuyến đường đến marker
function showRouteToMarker(friendMarker){
  if(!myMarker) return alert("Chưa xác định vị trí của bạn!");

  const from = myMarker.getLatLng();
  const to = friendMarker.getLatLng();

  if(routeLine) map.removeLayer(routeLine);

  const url = `https://router.project-osrm.org/route/v1/driving/${from.lng},${from.lat};${to.lng},${to.lat}?overview=full&geometries=geojson`;
  fetch(url).then(res=>res.json()).then(data=>{
    if(data.code!=="Ok"){ alert("Không tìm được đường"); return; }
    const coords = data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
    routeLine = L.polyline(coords,{color:'blue',weight:5}).addTo(map);
    map.fitBounds(routeLine.getBounds());
  }).catch(err=>{
    console.error(err); alert("Lỗi khi lấy route");
  });
}

// Hủy tuyến đường hiện tại
function cancelRoute(){
  if(routeLine){
    map.removeLayer(routeLine);
    routeLine = null;
  }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tracking App VN Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
#map { width:100%; height:100%; }
#controls {
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  background:white; padding:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.3);
  z-index:9999; text-align:center; transition:all 0.3s;
}
#controls.minimized { padding:5px; font-size:12px; }
input, button { margin:4px; padding:10px; font-size:16px; border-radius:6px; border:1px solid #ccc; }
button { cursor:pointer; }
#cancelBtn { background-color:#e74c3c; color:white; font-weight:bold; display:none; }
#cancelBtn:hover { background-color:#c0392b; }
</style>
</head>
<body>

<div id="controls">
  <input type="text" id="deviceName" placeholder="Tên thiết bị">
  <button onclick="join()">Join</button>
  <br>
  <button id="cancelBtn" onclick="cancelRoute()">Hủy chỉ đường</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCn1K76GDbRiXN6_n3yNBgzvb6taUXGOVM",
  authDomain: "tracking-bb8db.firebaseapp.com",
  databaseURL: "https://tracking-bb8db-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tracking-bb8db",
  storageBucket: "tracking-bb8db.appspot.com",
  messagingSenderId: "376993985667",
  appId: "1:376993985667:web:bb7dfb60f76c9ba5f8d7b6",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Map chuẩn OSM
const map = L.map('map').setView([16.0471,108.2068],6);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);

let myName, deviceId, userRef;
let myMarker;
let markers = {};
let routeLine;
let currentFriend = null;
const roomId = 'default-room';

// Join room
function join(){
  myName = document.getElementById('deviceName').value.trim();
  if(!myName){ alert("Nhập tên thiết bị!"); return; }

  // deviceId duy nhất trên client
  deviceId = 'device_' + Math.random().toString(36).substr(2,9);
  userRef = db.ref(`rooms/${roomId}/${deviceId}`);

  // Thiết lập xóa tự động khi mất kết nối
  userRef.onDisconnect().remove();

  document.getElementById('controls').classList.add('minimized');

  if(navigator.geolocation){
    navigator.geolocation.watchPosition(pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      userRef.set({name:myName,lat,lng,timestamp:Date.now()});

      if(!myMarker){
        myMarker = L.marker([lat,lng],{title:"Tôi", icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',iconSize:[32,32]})})
                    .addTo(map).bindPopup("Tôi").openPopup();
      } else {
        myMarker.setLatLng([lat,lng]);
      }

      map.setView([lat,lng]);
      if(currentFriend) showRouteToMarker(currentFriend);

    }, err=>console.error(err), {enableHighAccuracy:true});
  }

  // Lắng nghe tất cả thiết bị
  db.ref(`rooms/${roomId}`).on('value', snap=>{
    const devices = snap.val()||{};
    updateMarkers(devices);
  });
}

// Cập nhật marker
function updateMarkers(devices){
  // Xóa marker không còn trong DB
  for(const id in markers){
    if(!devices[id]){
      map.removeLayer(markers[id]);
      delete markers[id];
    }
  }

  for(const id in devices){
    const {name,lat,lng}=devices[id];
    if(!lat||!lng) continue;
    if(id===deviceId) continue;

    if(!markers[id]){
      const m = L.marker([lat,lng],{title:name}).addTo(map).bindPopup(name);
      m.on('click', ()=>{ currentFriend=m; showRouteToMarker(m); });
      markers[id] = m;
    } else {
      markers[id].setLatLng([lat,lng]);
    }
  }
}

// Vẽ tuyến đường
function showRouteToMarker(friendMarker){
  if(!myMarker) return;
  const from = myMarker.getLatLng();
  const to = friendMarker.getLatLng();

  if(routeLine) map.removeLayer(routeLine);

  fetch(`https://router.project-osrm.org/route/v1/driving/${from.lng},${from.lat};${to.lng},${to.lat}?overview=full&geometries=geojson`)
    .then(res=>res.json())
    .then(data=>{
      if(data.code!=="Ok"){ alert("Không tìm được đường"); return; }
      const coords = data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
      routeLine = L.polyline(coords,{color:'blue',weight:5}).addTo(map);
      map.fitBounds(routeLine.getBounds());
      document.getElementById('cancelBtn').style.display='inline-block';
      const info = data.routes[0].legs[0];
      const km = (info.distance/1000).toFixed(1);
      const min = Math.ceil(info.duration/60);
      friendMarker.bindPopup(`${friendMarker.options.title}<br>Khoảng cách: ${km} km<br>Thời gian: ${min} phút`).openPopup();
    }).catch(err=>{console.error(err); alert("Lỗi khi lấy route");});
}

// Hủy tuyến đường
function cancelRoute(){
  if(routeLine){
    map.removeLayer(routeLine);
    routeLine = null;
    currentFriend = null;
    document.getElementById('cancelBtn').style.display='none';
  }
}
</script>
</body>
</html>
